<!DOCTYPE html>
<!-- saved from url=(0576)https://render.githubusercontent.com/view/ipynb?commit=cabdc134993cf3c712e092cbdd1634b124e21f13&enc_url=68747470733a2f2f7261772e67697468756275736572636f6e74656e742e636f6d2f4672616e636573636f5361766572696f5a757070696368696e692f5079746f7263684d6f64756c6553746f726167652f636162646331333439393363663363373132653039326362646431363334623132346532316631332f5079746f7263684d6f64756c6553746f726167652e6970796e62&nwo=FrancescoSaverioZuppichini%2FPytorchModuleStorage&path=PytorchModuleStorage.ipynb&repository_id=199446677&repository_type=Repository#370f3466-a52c-40bf-80af-820544371edf -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Render</title>
  <meta name="referrer" content="never">
    <script src="./ipynb-0af7578295a2e6aa289c70ec5144846e.js"></script><link rel="stylesheet" href="./ipynb-cdc8a2c29b9e77afb5ead41e895d2850.css">


</head>
<body class="" data-render-url="https://render.githubusercontent.com" data-github-hostname="github.com" style="">
  <div class="render-shell js-render-shell" data-document-nwo="FrancescoSaverioZuppichini/PytorchModuleStorage" data-document-commit="cabdc134993cf3c712e092cbdd1634b124e21f13" data-document-path="PytorchModuleStorage.ipynb" data-file="https://github-render.s3.amazonaws.com/prod/ea990446d4eaf90855a0165362e60b0f-render.html?AWSAccessKeyId=AKIAJILR36AMCOMBK3MQ&amp;Signature=evczVMAHYHJ861Q0fqsVj8CFgLg%3D&amp;Expires=1564837433" data-meta="https://github-render.s3.amazonaws.com/prod/ea990446d4eaf90855a0165362e60b0f-meta.json?AWSAccessKeyId=AKIAJILR36AMCOMBK3MQ&amp;Signature=VndhDdDp1awtiYXDMh53xP4/NkY%3D&amp;Expires=1564837433">
    

<div class="render-info">
  <div class="js-viewer-health render-health is-viewer-good">
    <span class="symbol">⊖</span>
    <span class="js-message message">Everything running smoothly!</span>
  </div>
</div>

<div id="notebook" class="js-html">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span><span class="p">,</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="k">import</span> <span class="n">pprint</span>

<span class="kn">from</span> <span class="nn">torchvision.models</span> <span class="k">import</span> <span class="n">vgg16</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">'cuda'</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">'cpu'</span><span class="p">)</span>
<span class="n">cnn</span> <span class="o">=</span> <span class="n">vgg16</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">MutipleKeysDict</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Allow to get values from multiple keys. Example:</span>
<span class="sd">    </span>
<span class="sd">    ```python</span>
<span class="sd">    d = MutipleKeysDict({ 'a' : 1, 'b' : 2, 'c' : 3})</span>
<span class="sd">    d[['a', 'b']]</span>
<span class="sd">    # out [1,2]</span>
<span class="sd">    ```</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[20]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">ModuleStorage</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">where2layers</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">where2layers</span> <span class="o">=</span> <span class="n">where2layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">where</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unsubcribe</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">MutipleKeysDict</span><span class="p">({</span> 
            <span class="n">k</span> <span class="p">:</span> <span class="n">MutipleKeysDict</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">where2layers</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="k">else</span> <span class="p">[]</span> 
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span> 
        <span class="p">})</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">where2layers</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">where2layers</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">where2layers</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">where2layers</span>
        <span class="k">return</span> <span class="n">names</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">layers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Flat all the layers in the same array</span>
<span class="sd">        """</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">where2layers</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">where2layers</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">where2layers</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">where2layers</span>
        <span class="k">return</span> <span class="n">layers</span> 
    
    <span class="k">def</span> <span class="nf">register_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">'forward'</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Loop in all the layers and register a hook. There is ONLY one hook per layer to improve</span>
<span class="sd">        performance.</span>
<span class="sd">        """</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="c1"># create a hash of a layer as an identifier, this is unique</span>
<span class="c1">#             name = f"{type(layer).__name__.lower()}-{hash(layer)}"</span>
            <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s1">'forward'</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unsubcribe</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">register_forward_hook</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">layer</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">how</span> <span class="o">==</span> <span class="s1">'backward'</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unsubcribe</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">register_backward_hook</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">layer</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"type must be 'forward' or 'backward'"</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[INFO] </span><span class="si">{how}</span><span class="s2"> hook registered to </span><span class="si">{layer}</span><span class="s2">"</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"</span><span class="si">{m}</span><span class="s2"> called"</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">where2layers</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="c1">#       store only the outputs from the correct layers defined in self.where2layers</span>
            <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">where2layers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">where2layers</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> 
            
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">'[INFO] clear'</span><span class="p">)</span>
        <span class="p">[</span><span class="n">un</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span> <span class="k">for</span> <span class="n">un</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsubcribe</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">where</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="k">raise</span><span class="p">(</span><span class="n">f</span><span class="s2">"we cannot find any layers with key </span><span class="si">{where}</span><span class="s2">"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">where</span> <span class="o">=</span> <span class="n">where</span>
        
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">items</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">MutipleKeysDict</span> <span class="k">else</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="p">[{</span><span class="n">i</span> <span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">items</span><span class="p">(</span><span class="n">v</span><span class="p">)}]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>    

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2>Store input for multiple layers<a class="anchor-link" href="https://render.githubusercontent.com/view/ipynb?commit=cabdc134993cf3c712e092cbdd1634b124e21f13&amp;enc_url=68747470733a2f2f7261772e67697468756275736572636f6e74656e742e636f6d2f4672616e636573636f5361766572696f5a757070696368696e692f5079746f7263684d6f64756c6553746f726167652f636162646331333439393363663363373132653039326362646431363334623132346532316631332f5079746f7263684d6f64756c6553746f726167652e6970796e62&amp;nwo=FrancescoSaverioZuppichini%2FPytorchModuleStorage&amp;path=PytorchModuleStorage.ipynb&amp;repository_id=199446677&amp;repository_type=Repository#Store-input-for-multiple-layers">¶</a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[22]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">ForwardModuleStorage</span><span class="p">(</span><span class="n">ModuleStorage</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_hooks</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">'forward'</span><span class="p">)</span>
        
        
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">(</span><span class="n">_x</span><span class="p">)</span> <span class="k">for</span> <span class="n">_x</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        
<span class="n">storage</span> <span class="o">=</span> <span class="n">ForwardModuleStorage</span><span class="p">(</span><span class="n">cnn</span><span class="p">,</span> <span class="p">{</span><span class="s1">'style'</span> <span class="p">:</span> <span class="p">[</span><span class="n">cnn</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">5</span><span class="p">]],</span> <span class="s1">'content'</span> <span class="p">:</span> <span class="p">[</span><span class="n">cnn</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">cnn</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">10</span><span class="p">]]})</span>
<span class="n">storage</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="s1">'style'</span><span class="p">)</span>
<span class="n">storage</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="s1">'content'</span><span class="p">)</span>

<span class="n">pprint</span><span class="p">(</span><span class="n">storage</span><span class="p">[</span><span class="s1">'style'</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="n">storage</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="k">del</span> <span class="n">storage</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>odict_keys([Conv2d(64, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))])
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2>Store multiple inputs for same layers<a class="anchor-link" href="https://render.githubusercontent.com/view/ipynb?commit=cabdc134993cf3c712e092cbdd1634b124e21f13&amp;enc_url=68747470733a2f2f7261772e67697468756275736572636f6e74656e742e636f6d2f4672616e636573636f5361766572696f5a757070696368696e692f5079746f7263684d6f64756c6553746f726167652f636162646331333439393363663363373132653039326362646431363334623132346532316631332f5079746f7263684d6f64756c6553746f726167652e6970796e62&amp;nwo=FrancescoSaverioZuppichini%2FPytorchModuleStorage&amp;path=PytorchModuleStorage.ipynb&amp;repository_id=199446677&amp;repository_type=Repository#Store-multiple-inputs-for-same-layers">¶</a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[25]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">storage</span> <span class="o">=</span> <span class="n">ForwardModuleStorage</span><span class="p">(</span><span class="n">cnn</span><span class="p">,</span> <span class="p">[</span><span class="n">cnn</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">cnn</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">9</span><span class="p">]])</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">storage</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>

<span class="n">storage</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="n">pprint</span><span class="p">(</span><span class="n">storage</span><span class="p">[</span><span class="n">cnn</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>[tensor([[[[0.0000, 0.0000, 0.0000,  ..., 0.0000, 0.0000, 0.0000],
          [0.0000, 0.0000, 0.0000,  ..., 0.0000, 0.0000, 0.0000],
          [0.0000, 0.0000, 0.0000,  ..., 0.0000, 0.0000, 0.0000],
          ...,
          [0.0000, 0.0000, 0.0000,  ..., 0.0000, 0.0000, 0.0000],
          [0.0000, 0.0000, 0.0000,  ..., 0.0000, 0.0000, 0.0000],
          [0.0000, 0.0000, 0.0000,  ..., 0.0000, 0.0000, 0.0000]],

         [[0.0000, 0.0000, 0.0000,  ..., 0.0000, 0.0000, 0.0000],
          [0.0000, 0.0000, 0.0000,  ..., 0.0000, 0.0000, 0.0000],
          [0.0000, 0.0000, 0.0000,  ..., 0.0000, 0.0000, 0.0000],
          ...,
          [0.0000, 0.0000, 0.0000,  ..., 0.0000, 0.0000, 0.0000],
          [0.0000, 0.0000, 0.0000,  ..., 0.0000, 0.0000, 0.0000],
          [0.0000, 0.0000, 0.0000,  ..., 0.0000, 0.0000, 0.0000]],

         [[0.0000, 0.0639, 0.1510,  ..., 0.1072, 0.2296, 0.2635],
          [0.0000, 0.2039, 0.0981,  ..., 0.0552, 0.1525, 0.2407],
          [0.0000, 0.0676, 0.1154,  ..., 0.0868, 0.2180, 0.1837],
          ...,
          [0.0000, 0.0719, 0.1673,  ..., 0.1239, 0.1000, 0.2005],
          [0.0000, 0.1108, 0.0981,  ..., 0.0817, 0.1170, 0.2060],
          [0.0000, 0.0204, 0.0000,  ..., 0.0000, 0.0400, 0.0833]],

         ...,

         [[0.0000, 0.0000, 0.0000,  ..., 0.0000, 0.0000, 0.0000],
          [0.0000, 0.0000, 0.0000,  ..., 0.0000, 0.0000, 0.0000],
          [0.0000, 0.0000, 0.0000,  ..., 0.0000, 0.0000, 0.0000],
          ...,
          [0.0000, 0.0000, 0.0000,  ..., 0.0000, 0.0000, 0.0000],
          [0.0000, 0.0000, 0.0000,  ..., 0.0000, 0.0000, 0.0000],
          [0.0000, 0.0962, 0.1169,  ..., 0.0994, 0.0512, 0.0926]],

         [[0.2010, 0.1628, 0.2299,  ..., 0.2754, 0.1224, 0.0969],
          [0.2261, 0.0469, 0.0210,  ..., 0.0000, 0.0000, 0.0007],
          [0.1354, 0.0505, 0.0000,  ..., 0.0000, 0.0000, 0.0000],
          ...,
          [0.1594, 0.0000, 0.0000,  ..., 0.0000, 0.0000, 0.0000],
          [0.0739, 0.0174, 0.0015,  ..., 0.0000, 0.0000, 0.0000],
          [0.0000, 0.0000, 0.0000,  ..., 0.0000, 0.0000, 0.0000]],

         [[0.0000, 0.0710, 0.1394,  ..., 0.1151, 0.1851, 0.1788],
          [0.0335, 0.2938, 0.2569,  ..., 0.2509, 0.2469, 0.3626],
          [0.0200, 0.2005, 0.2231,  ..., 0.1421, 0.2382, 0.2971],
          ...,
          [0.1300, 0.2280, 0.2797,  ..., 0.2157, 0.2145, 0.3134],
          [0.1328, 0.2739, 0.2620,  ..., 0.1939, 0.3083, 0.3529],
          [0.0000, 0.1032, 0.1180,  ..., 0.1404, 0.1823, 0.2083]]]],
       grad_fn=&lt;ReluBackward1&gt;),
 tensor([[[[0.0000e+00, 0.0000e+00, 0.0000e+00,  ..., 0.0000e+00,
           0.0000e+00, 0.0000e+00],
          [0.0000e+00, 0.0000e+00, 0.0000e+00,  ..., 0.0000e+00,
           0.0000e+00, 0.0000e+00],
          [0.0000e+00, 0.0000e+00, 0.0000e+00,  ..., 0.0000e+00,
           0.0000e+00, 0.0000e+00],
          ...,
          [0.0000e+00, 0.0000e+00, 0.0000e+00,  ..., 0.0000e+00,
           0.0000e+00, 0.0000e+00],
          [0.0000e+00, 0.0000e+00, 0.0000e+00,  ..., 0.0000e+00,
           0.0000e+00, 0.0000e+00],
          [0.0000e+00, 0.0000e+00, 0.0000e+00,  ..., 0.0000e+00,
           0.0000e+00, 0.0000e+00]],

         [[0.0000e+00, 0.0000e+00, 0.0000e+00,  ..., 0.0000e+00,
           0.0000e+00, 0.0000e+00],
          [0.0000e+00, 0.0000e+00, 0.0000e+00,  ..., 0.0000e+00,
           0.0000e+00, 0.0000e+00],
          [0.0000e+00, 0.0000e+00, 0.0000e+00,  ..., 0.0000e+00,
           0.0000e+00, 0.0000e+00],
          ...,
          [0.0000e+00, 0.0000e+00, 0.0000e+00,  ..., 0.0000e+00,
           0.0000e+00, 0.0000e+00],
          [0.0000e+00, 0.0000e+00, 0.0000e+00,  ..., 0.0000e+00,
           0.0000e+00, 0.0000e+00],
          [0.0000e+00, 0.0000e+00, 0.0000e+00,  ..., 0.0000e+00,
           0.0000e+00, 0.0000e+00]],

         [[0.0000e+00, 1.1636e-01, 8.4750e-02,  ..., 1.3383e-01,
           1.2086e-01, 2.4677e-01],
          [0.0000e+00, 1.0689e-01, 6.3760e-02,  ..., 2.0695e-01,
           8.9843e-02, 1.7956e-01],
          [0.0000e+00, 7.2678e-02, 9.8358e-02,  ..., 2.2998e-01,
           1.4402e-01, 2.1897e-01],
          ...,
          [0.0000e+00, 1.3054e-01, 0.0000e+00,  ..., 1.0779e-01,
           9.8587e-02, 2.4621e-01],
          [0.0000e+00, 4.8274e-02, 9.9266e-02,  ..., 1.5459e-01,
           1.0322e-01, 1.7389e-01],
          [0.0000e+00, 2.2023e-02, 0.0000e+00,  ..., 0.0000e+00,
           2.1377e-02, 1.2306e-01]],

         ...,

         [[0.0000e+00, 0.0000e+00, 0.0000e+00,  ..., 0.0000e+00,
           0.0000e+00, 0.0000e+00],
          [0.0000e+00, 0.0000e+00, 0.0000e+00,  ..., 0.0000e+00,
           0.0000e+00, 2.0856e-02],
          [0.0000e+00, 0.0000e+00, 0.0000e+00,  ..., 0.0000e+00,
           0.0000e+00, 0.0000e+00],
          ...,
          [0.0000e+00, 0.0000e+00, 0.0000e+00,  ..., 0.0000e+00,
           0.0000e+00, 0.0000e+00],
          [0.0000e+00, 0.0000e+00, 0.0000e+00,  ..., 0.0000e+00,
           0.0000e+00, 0.0000e+00],
          [0.0000e+00, 6.9016e-02, 8.0041e-02,  ..., 2.3164e-02,
           7.7826e-02, 2.5241e-04]],

         [[1.8758e-01, 3.2473e-01, 2.1647e-01,  ..., 2.0702e-01,
           1.1923e-01, 8.6870e-02],
          [1.5906e-01, 1.0808e-01, 3.9516e-02,  ..., 0.0000e+00,
           5.9665e-03, 0.0000e+00],
          [7.0442e-02, 3.5314e-03, 2.3734e-02,  ..., 0.0000e+00,
           0.0000e+00, 0.0000e+00],
          ...,
          [1.2310e-01, 0.0000e+00, 0.0000e+00,  ..., 0.0000e+00,
           8.3207e-03, 0.0000e+00],
          [1.1256e-01, 0.0000e+00, 0.0000e+00,  ..., 0.0000e+00,
           0.0000e+00, 0.0000e+00],
          [0.0000e+00, 0.0000e+00, 0.0000e+00,  ..., 0.0000e+00,
           0.0000e+00, 0.0000e+00]],

         [[0.0000e+00, 5.6534e-02, 6.9069e-02,  ..., 1.1212e-01,
           9.7612e-02, 2.0289e-01],
          [3.2672e-02, 2.1310e-01, 1.5935e-01,  ..., 2.8662e-01,
           1.9163e-01, 3.3967e-01],
          [8.6156e-02, 1.7997e-01, 1.9340e-01,  ..., 2.1803e-01,
           2.3491e-01, 3.1889e-01],
          ...,
          [1.1567e-01, 2.3913e-01, 1.7124e-01,  ..., 2.4505e-01,
           2.8180e-01, 3.4749e-01],
          [1.2681e-01, 2.5659e-01, 2.0765e-01,  ..., 2.4890e-01,
           1.9258e-01, 3.6959e-01],
          [0.0000e+00, 1.8135e-01, 1.1558e-01,  ..., 1.3067e-01,
           1.0760e-01, 2.5146e-01]]]], grad_fn=&lt;ReluBackward1&gt;)]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">BackwardModuleStorage</span><span class="p">(</span><span class="n">ModuleStorage</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_hooks</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">'backward'</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="p">[</span><span class="n">_x</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span> <span class="k">for</span> <span class="n">_x</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

<span class="n">storage</span> <span class="o">=</span> <span class="n">BackwardModuleStorage</span><span class="p">({</span><span class="s1">'style'</span> <span class="p">:</span> <span class="p">[</span><span class="n">cnn</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">5</span><span class="p">]],</span> <span class="s1">'content'</span> <span class="p">:</span> <span class="p">[</span><span class="n">cnn</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">cnn</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">10</span><span class="p">]]})</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">cnn</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
<span class="n">storage</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">'style'</span><span class="p">)</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">storage</span><span class="p">[</span><span class="s1">'style'</span><span class="p">])</span>

<span class="n">storage</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>MutipleKeysDict([(Conv2d(64, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1)),
                  (tensor([[[[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]],

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]],

         [[ 0.0000e+00, -4.1749e-03,  4.5930e-03,  ...,  1.9435e-03,
           -1.2495e-03, -1.1976e-04],
          [ 0.0000e+00,  3.2739e-04,  1.0904e-02,  ..., -3.1673e-05,
           -1.3323e-03, -3.1260e-04],
          [ 0.0000e+00,  1.4249e-03, -5.0437e-03,  ..., -1.9025e-03,
           -3.4659e-03, -3.3470e-03],
          ...,
          [ 0.0000e+00,  2.8339e-03,  2.9887e-03,  ...,  1.8987e-03,
            1.5888e-03,  1.4776e-03],
          [ 0.0000e+00, -7.3478e-03, -6.1771e-03,  ...,  1.1677e-03,
            2.3592e-05, -1.9974e-03],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
           -1.3294e-03,  1.1488e-03]],

         ...,

         [[ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  6.7813e-04, -4.4133e-04,  ...,  7.2032e-04,
            2.2245e-03, -1.3370e-03]],

         [[-7.9905e-04,  7.1394e-04,  1.4463e-03,  ...,  2.8972e-03,
            3.3403e-06,  1.9691e-03],
          [-2.8441e-03, -3.4072e-03,  1.0808e-03,  ...,  1.4936e-04,
            0.0000e+00,  0.0000e+00],
          [ 9.2034e-04, -2.8869e-03,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          ...,
          [-1.3411e-03,  0.0000e+00,  0.0000e+00,  ..., -1.8533e-03,
            0.0000e+00,  0.0000e+00],
          [ 1.8744e-03,  0.0000e+00, -3.4953e-03,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00],
          [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  ...,  0.0000e+00,
            0.0000e+00,  0.0000e+00]],

         [[ 0.0000e+00,  0.0000e+00,  9.4998e-04,  ..., -2.3133e-03,
           -1.3776e-03, -3.7028e-03],
          [ 1.3744e-03, -1.0977e-03,  8.4094e-04,  ..., -8.0773e-04,
           -9.2870e-04,  2.7529e-03],
          [-3.7447e-03, -4.7988e-03, -9.9438e-05,  ..., -3.6808e-04,
           -1.1724e-04,  4.5638e-04],
          ...,
          [-1.7023e-03, -2.5785e-03,  1.6681e-03,  ...,  2.0028e-03,
           -2.0529e-03,  7.0614e-04],
          [ 1.8094e-03, -2.5936e-03,  6.1589e-03,  ...,  5.4279e-03,
           -3.9713e-03,  3.9225e-04],
          [-1.3180e-03,  2.9528e-03, -1.1308e-03,  ...,  1.2964e-03,
            1.5001e-03, -1.1318e-03]]]]),))])
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">storage</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

</div>
 

</div>

  </div>

  



</body></html>